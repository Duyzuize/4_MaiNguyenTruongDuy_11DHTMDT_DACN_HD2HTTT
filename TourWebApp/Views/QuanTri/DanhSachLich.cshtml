@model List<TourWebApp.Data.Models.LichKhoiHanh>
@{
    ViewData["Title"] = "Qu·∫£n l√Ω l·ªãch kh·ªüi h√†nh";
   Layout = "~/Views/Shared/_LayoutAdmin.cshtml";

}


<h3 class="mb-3"><i class="fa fa-calendar"></i> Qu·∫£n l√Ω l·ªãch kh·ªüi h√†nh</h3>

@if (TempData["ThongBao"] != null)
{
    <div class="alert alert-success">@TempData["ThongBao"]</div>
}
@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">@TempData["Error"]</div>
}

<!-- ================= FORM TH√äM L·ªäCH ================= -->
<div class="card p-4 mb-4 shadow-sm">
    <h5 class="mb-3">‚ûï Th√™m l·ªãch kh·ªüi h√†nh m·ªõi</h5>

    <form asp-action="ThemLich" method="post">
        <div class="row g-3">

            <!-- CH·ªåN TOUR -->
            <div class="col-md-4">
                <label>üó∫ Tour</label>
                <select name="IdTour" class="form-select" required>
                    <option value="">-- Ch·ªçn tour --</option>
                    @foreach (var t in ViewBag.Tours)
                    {
                        <option value="@t.IdTour">@t.TenTour</option>
                    }
                </select>
            </div>

            <!-- NG√ÄY -->
            <div class="col-md-4">
                <label>üìÖ Ng√†y kh·ªüi h√†nh</label>
                <input id="ngayThem" type="text" name="NgayKhoiHanh"
                       class="form-control" required />
            </div>

            <!-- GI·ªú -->
            <div class="col-md-4">
                <label>üïí Gi·ªù kh·ªüi h√†nh</label>
                <input id="gioThem" type="text" name="GioKhoiHanh"
                       class="form-control" required />
            </div>

            <!-- S·ªê CH·ªñ -->
            <div class="col-md-4">
                <label>üë• S·ªë ch·ªó t·ªëi ƒëa</label>
                <input type="number" name="SoChoToiDa"
                       class="form-control" min="1" required />
            </div>

        </div>

        <button class="btn btn-success mt-3">
            <i class="fa fa-plus"></i> Th√™m l·ªãch
        </button>
    </form>
</div>

<!-- ================= B·∫¢NG DANH S√ÅCH ================= -->
<table class="table table-bordered align-middle">
    <thead class="table-light">
        <tr>
            <th>Tour</th>
            <th>Ng√†y</th>
            <th>Gi·ªù</th>
            <th>Ch·ªó t·ªëi ƒëa</th>
            <th>Ch·ªó c√≤n</th>
            <th>Tr·∫°ng th√°i</th>
            <th width="120">H√†nh ƒë·ªông</th>
        </tr>
    </thead>

    <tbody>
@foreach (var item in Model)
{
    var phanTram = (double)item.SoChoConLai / item.SoChoToiDa * 100;

    string mau = phanTram == 0 ? "bg-danger" :
                 phanTram <= 50 ? "bg-warning text-dark" :
                 "bg-success";

    <tr>
        <td>@item.IdTourNavigation?.TenTour</td>
        <td>@item.NgayKhoiHanh</td>
        <td>@item.GioKhoiHanh</td>
        <td>@item.SoChoToiDa</td>

        <!-- CH·ªñ C√íN + M√ÄU THEO % -->
        <td>
            <span class="badge @mau">
                @item.SoChoConLai / @item.SoChoToiDa
            </span>
        </td>

        <td>
            @(item.SoChoConLai > 0 ? "C√≤n ch·ªó" : "H·∫øt ch·ªó")
        </td>

        <td class="text-center">

           @{
             bool daCoDon = item.DonDatTours != null && item.DonDatTours.Any(d => d.TrangThai != "DaHuy");
            }

            @if (daCoDon)
            {
                <!-- ƒê√É C√ì ƒê∆†N => KH√ìA S·ª¨A -->
                <button class="btn btn-secondary btn-sm" disabled
                        title="ƒê√£ c√≥ ng∆∞·ªùi ƒë·∫∑t - kh√¥ng th·ªÉ s·ª≠a">
                    <i class="fa fa-lock"></i>
                </button>
            }
            else
            {
                <!-- CH∆ØA C√ì ƒê∆†N => CHO PH√âP S·ª¨A -->
                <button type="button"
                        class="btn btn-warning btn-sm me-1"
                        onclick="moModalSua(@item.IdLich,
                        '@item.NgayKhoiHanh.ToString("yyyy-MM-dd")',
                        '@(item.GioKhoiHanh.HasValue ? item.GioKhoiHanh.Value.ToString("HH:mm") : "")',
                        @item.SoChoToiDa)">
                    <i class="fa fa-pen"></i>
                </button>
            }

            <!-- X√ìA -->
            <form asp-action="XoaLich" method="post" style="display:inline-block">
                <input type="hidden" name="id" value="@item.IdLich" />
                <button type="submit"
                        class="btn btn-danger btn-sm"
                        onclick="return confirm('X√≥a l·ªãch n√†y?')">
                    <i class="fa fa-trash"></i>
                </button>
            </form>

        </td>
    </tr>
}
</tbody>

</table>

<!-- ================= MODAL S·ª¨A ================= -->
<div class="modal fade" id="modalSuaLich" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">

            <form asp-action="SuaLich" asp-controller="QuanTri" method="post">

                @Html.AntiForgeryToken()

                <div class="modal-header">
                    <h5 class="modal-title">‚úèÔ∏è S·ª≠a l·ªãch</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">

                    <!-- ID l·ªãch c·∫ßn s·ª≠a -->
                    <input type="hidden" id="editId" name="IdLich" />

                    <div class="mb-3">
                        <label>üìÖ Ng√†y</label>
                        <input id="ngaySua"
                               name="NgayKhoiHanh"
                               type="date"
                               class="form-control"
                               required />
                    </div>

                    <div class="mb-3">
                        <label>üïí Gi·ªù</label>
                        <input id="gioSua"
                               name="GioKhoiHanh"
                               type="time"
                               class="form-control"
                               required />
                    </div>

                    <div class="mb-3">
                        <label>üë• S·ªë ch·ªó t·ªëi ƒëa</label>
                        <input id="soChoSua"
                               name="SoChoToiDa"
                               type="number"
                               min="1"
                               class="form-control"
                               required />
                    </div>

                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">
                        <i class="fa fa-save"></i> L∆∞u
                    </button>
                </div>

            </form>
        </div>
    </div>
</div>

<!-- ================= TH∆Ø VI·ªÜN ================= -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="~/js/lich-khoi-hanh.js"></script>
